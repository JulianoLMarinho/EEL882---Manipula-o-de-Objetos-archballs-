<!DOCTYPE html>
<html lang="en">

<head>
    <title>ARCBALLS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        body {
            background-color: #f0f0f0;
            color: #444;
        }

        a {
            color: #08f;
        }
    </style>
</head>

<body>


    <script src="js/three.js"></script>

    <script src="js/DragControls.js"></script>
    <script src="js/TrackballControls.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/BufferGeometryUtils.js"></script>


    <script>
        var container, stats;
        var camera, controls, scene, renderer, dragControls;
        var objects = [];
        var objectsR = new THREE.Group();
        let sphere = new THREE.SphereGeometry(50, 32, 32);
        let material = new THREE.MeshLambertMaterial({ color: Math.random() * 0x000 })
        let t = new THREE.Mesh(sphere, material);
        t.visible = false;
        material.transparent = true;
        material.opacity = 0.3;
        var selectedObject = null;

        init();
        animate();
        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 5000);
            camera.position.z = 1000;
            scene = new THREE.Scene();
            
            scene.add(objectsR);
            scene.add(t);
            scene.background = new THREE.Color(0xf0f0f0);
            scene.add(new THREE.AmbientLight(0x505050));
            var light = new THREE.SpotLight(0xffffff, 1.5);
            light.position.set(0, 500, 2000);
            light.angle = Math.PI / 9;
            light.castShadow = true;
            light.shadow.camera.near = 1000;
            light.shadow.camera.far = 4000;
            light.shadow.mapSize.width = 1024;
            light.shadow.mapSize.height = 1024;
            scene.add(light);
            var geometry = new THREE.BoxBufferGeometry(40, 40, 40);
            for (var i = 0; i < 20; i++) {
                var object = new THREE.Mesh(geometry, new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff }));
                object.position.x = Math.random() * 500 - 500;
                object.position.y = Math.random() * 500 - 500;
                object.position.z = Math.random() * 500 - 500;
                object.rotation.x = Math.random() * 2 * Math.PI;
                object.rotation.y = Math.random() * 2 * Math.PI;
                object.rotation.z = Math.random() * 2 * Math.PI;
                object.scale.x = Math.random() * 2 + 1;
                object.scale.y = Math.random() * 2 + 1;
                object.scale.z = Math.random() * 2 + 1;
                //object.castShadow = true;
                //object.receiveShadow = true;
                objects.push(object);
                objectsR.add(object);
            }

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFShadowMap;
            container.appendChild(renderer.domElement);
            controls = new THREE.TrackballControls(camera, renderer.domElement);
            controls.rotateSpeed = 5.0;
            controls.zoomSpeed = 1.2;
            controls.panSpeed = 0.8;
            controls.noZoom = false;
            controls.enablePan = false;
            controls.dynamicDampingFactor = 0.3;
            var box = new THREE.Box3().setFromObject(objectsR);
            var size = box.getSize(new THREE.Vector3()).length();
            var center = box.getCenter(new THREE.Vector3());
            controls.target.set(center.x, center.y, center.z);
            dragControls = new THREE.DragControls(objects, camera, renderer.domElement);
            controls.enabled = false;
            dragControls.addEventListener('dragstart', function () {
                controls.enabled = t.visible && selectedObject==null;
            });
            dragControls.addEventListener('dragend', function () {
                controls.enabled = false;
                box = new THREE.Box3().setFromObject(objectsR);
                size = box.getSize(new THREE.Vector3());
                center = box.getCenter(new THREE.Vector3());
                controls.target.set(center.x, center.y, center.z);
                // t.position.x = center.x;
                // t.position.y = center.y;
                // t.position.z = center.z;
                // let bola = new THREE.Sphere();
                // box.getBoundingSphere(bola);
                // t.scale.x = bola.radius / 50;
                // t.scale.y = bola.radius / 50;
                // t.scale.z = bola.radius / 50;
            });
            stats = new Stats();
            //window.addEventListener("mousemove", onDocumentMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('dblclick', mouseDBClick);
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        //
        function animate() {
            requestAnimationFrame(animate);
            render();
            stats.update();
        }
        function render() {
            controls.update();
            renderer.render(scene, camera);
        }



        function mouseDBClick(event) {
            controls.enabled = false;   
            event.preventDefault();
            // if (selectedObject) {
            //     selectedObject = null;
            // }
            var intersects = getIntersects(event.layerX, event.layerY);
            if (intersects.length > 0) {
                var res = intersects.filter(function (res) {
                    return res && res.object;
                })[0];
                if (res && res.object) {
                    if (selectedObject == res.object) {
                        t.visible = false;
                    } else {
                        selectedObject = res.object;
                        box = new THREE.Box3().setFromObject(selectedObject)
                        size = box.getSize(new THREE.Vector3());
                        center = box.getCenter(new THREE.Vector3());
                        t.position.x = center.x;
                        t.position.y = center.y;
                        t.position.z = center.z;
                        let bola = new THREE.Sphere();
                        box.getBoundingSphere(bola);
                        t.scale.x = bola.radius / 50;
                        t.scale.y = bola.radius / 50;
                        t.scale.z = bola.radius / 50;
                        t.visible = true;
                    }
                }
            } else {
                box = new THREE.Box3().setFromObject(objectsR);
                size = box.getSize(new THREE.Vector3());
                center = box.getCenter(new THREE.Vector3());
                controls.target.set(center.x, center.y, center.z);
                t.position.x = center.x;
                t.position.y = center.y;
                t.position.z = center.z;
                let bola = new THREE.Sphere();
                box.getBoundingSphere(bola);
                t.scale.x = bola.radius / 50;
                t.scale.y = bola.radius / 50;
                t.scale.z = bola.radius / 50;
                t.visible = t.visible?false:true;
                controls.enabled = t.visible;
            }

            dragControls.enabled = !t.visible;
        }

        function onDocumentMouseMove(event) {
            event.preventDefault();
            //let color = "#000";
            if (selectedObject) {
                //selectedObject.material.color.set(color);
                //selectedObject.material.color.set('#69f');
                //console.log(1);
                selectedObject = null;
            }
            var intersects = getIntersects(event.layerX, event.layerY);
            if (intersects.length > 0) {
                var res = intersects.filter(function (res) {
                    return res && res.object;
                })[0];
                if (res && res.object) {
                    selectedObject = res.object;
                    //console.log(2);
                }
            }
        }
        var raycaster = new THREE.Raycaster();
        var mouseVector = new THREE.Vector3();
        function getIntersects(x, y) {

            x = (x / window.innerWidth) * 2 - 1;
            y = - (y / window.innerHeight) * 2 + 1;
            mouseVector.set(x, y, 0.5);
            raycaster.setFromCamera(mouseVector, camera);
            return raycaster.intersectObject(objectsR, true);
        }
    </script>

</body>

</html>